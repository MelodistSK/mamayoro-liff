<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é¢è«‡äºˆç´„ - ã¾ã¾ã‚ˆã‚äººæç´¹ä»‹</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: white;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .logo p {
            color: rgba(255,255,255,0.9);
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .info-box {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 0.9em;
            color: #555;
        }
        
        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #667eea;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8ebff;
        }
        
        .date-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .date-option {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }
        
        .date-option.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .date-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .date-option:not(.disabled):not(.selected):hover {
            border-color: #667eea;
            background: #f0f7ff;
        }
        
        .date-day {
            font-size: 0.7em;
            opacity: 0.7;
        }
        
        .date-number {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .time-slot {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .time-slot.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .time-slot.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .time-slot:not(.disabled):not(.selected):hover {
            border-color: #667eea;
            background: #f0f7ff;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-top: 30px;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            text-align: center;
            padding: 40px 20px;
        }
        
        .success-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .error-message {
            background: #ffe0e0;
            border-left: 4px solid #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }

        .month-header {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .weekday-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.75em;
            color: #999;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>ğŸŒ¸ ã¾ã¾ã‚ˆã‚äººæç´¹ä»‹</h1>
            <p>é¢è«‡äºˆç´„</p>
        </div>
        
        <div class="card">
            <div class="error-message" id="errorMessage"></div>
            
            <!-- ãƒšãƒ¼ã‚¸1: æ—¥æ™‚é¸æŠ -->
            <div class="page active" id="page1">
                <h2>é¢è«‡æ—¥æ™‚ã®é¸æŠ</h2>
                <div class="info-box">
                    ã”å¸Œæœ›ã®é¢è«‡æ—¥æ™‚ã‚’ãŠé¸ã³ãã ã•ã„ã€‚<br>
                    é¢è«‡æ™‚é–“ã¯30åˆ†ã§ã™ã€‚
                </div>
                
                <div class="section-title">æ—¥ä»˜ã‚’é¸æŠ</div>
                <div id="calendarContainer"></div>
                
                <div class="section-title">æ™‚é–“ã‚’é¸æŠ</div>
                <div class="time-slots" id="timeSlots">
                    <div class="time-slot disabled">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                </div>
                
                <button class="btn btn-primary" id="confirmButton" disabled>ã“ã®æ—¥æ™‚ã§äºˆç´„ã™ã‚‹</button>
            </div>
            
            <!-- ãƒšãƒ¼ã‚¸2: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
            <div class="page" id="page2">
                <div class="loading active">
                    <div class="spinner"></div>
                    <p>äºˆç´„ã‚’ç¢ºå®šã—ã¦ã„ã¾ã™...</p>
                </div>
            </div>
            
            <!-- ãƒšãƒ¼ã‚¸3: å®Œäº† -->
            <div class="page" id="page3">
                <div class="success-message">
                    <div class="success-icon">âœ…</div>
                    <h2>äºˆç´„å®Œäº†!</h2>
                    <p id="confirmationMessage"></p>
                </div>
                <button class="btn btn-primary" onclick="handleCloseWindow()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // è¨­å®šæƒ…å ±
        // ========================================
        const CONFIG = {
            LIFF_ID: '2008409890-bdVxpkD0'
        };

        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let lineProfile = null;
        let selectedDate = null;
        let selectedTime = null;
        let availableSlots = {};

        // ========================================
        // LIFFåˆæœŸåŒ–
        // ========================================
        window.addEventListener('load', async () => {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                // LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
                lineProfile = await liff.getProfile();
                console.log('LINE Profile:', lineProfile);
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰userIdã‚’å–å¾—(ç™»éŒ²å®Œäº†ãƒšãƒ¼ã‚¸ã‹ã‚‰é·ç§»ã—ãŸå ´åˆ)
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('userId');
                
                if (userId && userId !== lineProfile.userId) {
                    showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                    return;
                }
                
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
                await initializeCalendar();
                
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ========================================
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
        // ========================================
        async function initializeCalendar() {
            const container = document.getElementById('calendarContainer');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // 2é€±é–“åˆ†ã®æ—¥ä»˜ã‚’ç”Ÿæˆ
            const dates = [];
            for (let i = 0; i < 14; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                dates.push(date);
            }
            
            // æœˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const monthGroups = {};
            dates.forEach(date => {
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                if (!monthGroups[monthKey]) {
                    monthGroups[monthKey] = [];
                }
                monthGroups[monthKey].push(date);
            });
            
            // å„æœˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆ
            Object.entries(monthGroups).forEach(([monthKey, monthDates]) => {
                const firstDate = monthDates[0];
                const monthDiv = document.createElement('div');
                monthDiv.style.marginBottom = '30px';
                
                // æœˆã®ãƒ˜ãƒƒãƒ€ãƒ¼
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = `${firstDate.getFullYear()}å¹´${firstDate.getMonth() + 1}æœˆ`;
                monthDiv.appendChild(header);
                
                // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
                const weekdayHeader = document.createElement('div');
                weekdayHeader.className = 'weekday-header';
                ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
                    const dayDiv = document.createElement('div');
                    dayDiv.textContent = day;
                    weekdayHeader.appendChild(dayDiv);
                });
                monthDiv.appendChild(weekdayHeader);
                
                // æ—¥ä»˜ã‚°ãƒªãƒƒãƒ‰
                const gridDiv = document.createElement('div');
                gridDiv.className = 'date-selector';
                
                // â­ ä¿®æ­£: è¡¨ç¤ºã™ã‚‹æœ€åˆã®æ—¥ä»˜ã®æ›œæ—¥ã«åˆã‚ã›ã¦ç©ºç™½ã‚’è¿½åŠ 
                const startDay = firstDate.getDay(); // ã“ã®æœˆã§æœ€åˆã«è¡¨ç¤ºã™ã‚‹æ—¥ã®æ›œæ—¥
                
                for (let i = 0; i < startDay; i++) {
                    const emptyDiv = document.createElement('div');
                    gridDiv.appendChild(emptyDiv);
                }
                
                // æ—¥ä»˜ã‚’è¿½åŠ 
                monthDates.forEach(date => {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'date-option';
                    
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    
                    if (isWeekend) {
                        dateDiv.classList.add('disabled');
                    }
                    
                    const daySpan = document.createElement('div');
                    daySpan.className = 'date-day';
                    daySpan.textContent = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dayOfWeek];
                    
                    const numberSpan = document.createElement('div');
                    numberSpan.className = 'date-number';
                    numberSpan.textContent = date.getDate();
                    
                    dateDiv.appendChild(daySpan);
                    dateDiv.appendChild(numberSpan);
                    
                    if (!isWeekend) {
                        dateDiv.addEventListener('click', () => selectDate(date, dateDiv));
                    }
                    
                    gridDiv.appendChild(dateDiv);
                });
                
                monthDiv.appendChild(gridDiv);
                container.appendChild(monthDiv);
            });
        }

        // ========================================
        // æ—¥ä»˜é¸æŠ
        // ========================================
        async function selectDate(date, element) {
            // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.date-option.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠã‚’é©ç”¨
            element.classList.add('selected');
            selectedDate = date;
            selectedTime = null;
            
            // ç¢ºèªãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('confirmButton').disabled = true;
            
            // æ™‚é–“æ ã‚’èª­ã¿è¾¼ã¿
            await loadTimeSlots(date);
        }

        // ========================================
        // æ™‚é–“æ ã‚’èª­ã¿è¾¼ã¿
        // ========================================
        async function loadTimeSlots(date) {
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '<div class="time-slot disabled">èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            try {
                // â­ ä¿®æ­£: ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚’ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const response = await fetch(`/api/get-available-slots?date=${dateStr}`);
                
                if (!response.ok) {
                    throw new Error('ç©ºãæ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const data = await response.json();
                availableSlots = data.slots || {};
                
                timeSlotsContainer.innerHTML = '';
                
                if (Object.keys(availableSlots).length === 0) {
                    timeSlotsContainer.innerHTML = '<div class="time-slot disabled">ã“ã®æ—¥ã¯äºˆç´„ã§ãã¾ã›ã‚“</div>';
                    return;
                }
                
                Object.entries(availableSlots).forEach(([time, isAvailable]) => {
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'time-slot';
                    timeDiv.textContent = time;
                    
                    if (!isAvailable) {
                        timeDiv.classList.add('disabled');
                    } else {
                        timeDiv.addEventListener('click', () => selectTime(time, timeDiv));
                    }
                    
                    timeSlotsContainer.appendChild(timeDiv);
                });
                
            } catch (error) {
                console.error('Time slots loading error:', error);
                timeSlotsContainer.innerHTML = '<div class="time-slot disabled">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
                showError('ç©ºãæ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ========================================
        // æ™‚é–“é¸æŠ
        // ========================================
        function selectTime(time, element) {
            // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.time-slot.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠã‚’é©ç”¨
            element.classList.add('selected');
            selectedTime = time;
            
            // ç¢ºèªãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('confirmButton').disabled = false;
        }

        // ========================================
        // äºˆç´„ç¢ºå®š
        // ========================================
        document.getElementById('confirmButton').addEventListener('click', async () => {
            if (!selectedDate || !selectedTime) {
                showError('æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            goToPage(2); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            
            try {
                const [startHour, startMinute] = selectedTime.split(':');
                const startDateTime = new Date(selectedDate);
                startDateTime.setHours(parseInt(startHour), parseInt(startMinute), 0, 0);
                
                const endDateTime = new Date(startDateTime);
                endDateTime.setMinutes(endDateTime.getMinutes() + 30);
                
                // â­ ä¿®æ­£: ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚’ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›ãªã—ï¼‰
                const dateStr = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
                
                console.log('äºˆç´„ãƒ‡ãƒ¼ã‚¿:');
                console.log('- é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:', selectedDate);
                console.log('- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã®æ—¥ä»˜æ–‡å­—åˆ—:', dateStr);
                console.log('- é–‹å§‹æ™‚åˆ»:', selectedTime);
                
                const response = await fetch('/api/create-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: lineProfile.userId,
                        date: dateStr, // âœ… "2025-11-07" ã®ã‚ˆã†ãªå½¢å¼
                        startTime: selectedTime,
                        endTime: `${String(endDateTime.getHours()).padStart(2, '0')}:${String(endDateTime.getMinutes()).padStart(2, '0')}`
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const result = await response.json();
                
                // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
                const confirmationMessage = document.getElementById('confirmationMessage');
                const dateStrDisplay = `${selectedDate.getFullYear()}å¹´${selectedDate.getMonth() + 1}æœˆ${selectedDate.getDate()}æ—¥`;
                confirmationMessage.innerHTML = `
                    é¢è«‡äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br><br>
                    <strong>${dateStrDisplay} ${selectedTime}</strong><br><br>
                    æ‹…å½“è€…ã‚ˆã‚ŠLINEã§ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚
                `;
                
                goToPage(3);
                
            } catch (error) {
                console.error('Appointment creation error:', error);
                showError(error.message || 'äºˆç´„ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                goToPage(1);
            }
        });

        // ========================================
        // ãƒšãƒ¼ã‚¸é·ç§»
        // ========================================
        function goToPage(pageNumber) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page${pageNumber}`).classList.add('active');
            window.scrollTo(0, 0);
        }

        // ========================================
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        // ========================================
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.add('active');
            
            setTimeout(() => {
                errorElement.classList.remove('active');
            }, 5000);
        }

        // ========================================
        // ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
        // ========================================
        function handleCloseWindow() {
            if (liff.isInClient()) {
                // LINEã‚¢ãƒ—ãƒªå†… â†’ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
                liff.closeWindow();
            } else {
                // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                alert('äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nã“ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚');
                // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: è‡ªå‹•çš„ã«ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹è©¦ã¿
                window.close();
            }
        }
    </script>
</body>
</html>
