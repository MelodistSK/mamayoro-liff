<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é¢è«‡äºˆç´„ - ã¾ã¾ã‚ˆã‚äººæç´¹ä»‹</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: white;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .logo p {
            color: rgba(255,255,255,0.9);
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .info-box {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 0.9em;
            color: #555;
        }
        
        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #667eea;
            margin: 20px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8ebff;
        }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-header h3 {
            font-size: 1.2em;
            color: #333;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendar-nav button {
            width: 36px;
            height: 36px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .calendar-nav button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }
        
        .calendar-nav button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .weekday-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .weekday {
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
            color: #666;
            padding: 8px 0;
        }
        
        .weekday:first-child {
            color: #e74c3c;
        }
        
        .weekday:last-child {
            color: #3498db;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .date-cell {
            aspect-ratio: 1;
            border: none;
            background: #f5f5f5;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .date-cell:hover:not(:disabled):not(.empty) {
            background: #e8ebff;
        }
        
        .date-cell.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .date-cell:disabled {
            background: #f9f9f9;
            color: #ccc;
            cursor: not-allowed;
        }
        
        .date-cell.empty {
            background: transparent;
            cursor: default;
        }
        
        .date-cell.sunday {
            color: #e74c3c;
        }
        
        .date-cell.saturday {
            color: #3498db;
        }
        
        .date-cell.sunday:disabled,
        .date-cell.saturday:disabled {
            color: #ccc;
        }
        
        /* æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆ */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .time-slot {
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-size: 0.95em;
            transition: all 0.3s;
        }
        
        .time-slot:hover:not(:disabled) {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .time-slot.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        
        .time-slot:disabled {
            background: #f5f5f5;
            color: #aaa;
            cursor: not-allowed;
            border-color: #eee;
        }
        
        .time-slot .slot-time {
            font-weight: 600;
        }
        
        .time-slot .slot-status {
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        .time-slot:disabled .slot-status {
            color: #ccc;
        }
        
        /* é¸æŠã•ã‚ŒãŸæ—¥æ™‚ã®è¡¨ç¤º */
        .selected-datetime {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .selected-datetime .date {
            font-size: 1.3em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .selected-datetime .time {
            font-size: 1.1em;
            color: #666;
        }
        
        /* ãƒœã‚¿ãƒ³ */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #e0e0e0;
        }
        
        .btn-secondary:hover {
            background: #eee;
        }
        
        /* ãƒšãƒ¼ã‚¸è¡¨ç¤ºåˆ¶å¾¡ */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* å®Œäº†ç”»é¢ */
        .complete-icon {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .complete-icon .checkmark {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            animation: scaleIn 0.5s ease-out;
        }
        
        .complete-icon .checkmark svg {
            width: 40px;
            height: 40px;
            fill: white;
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .complete-message {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .complete-message h2 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .complete-message p {
            color: #666;
            line-height: 1.8;
        }
        
        .reservation-details {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .reservation-details h3 {
            color: #667eea;
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .reservation-details .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e8ebff;
        }
        
        .reservation-details .detail-row:last-child {
            border-bottom: none;
        }
        
        .reservation-details .label {
            color: #666;
        }
        
        .reservation-details .value {
            font-weight: 600;
            color: #333;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading p {
            color: #666;
            font-size: 1.1em;
        }
        
        /* ã‚¨ãƒ©ãƒ¼ */
        .error-message {
            background: #fff5f5;
            border: 1px solid #ffcccc;
            color: #e74c3c;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }
        
        .error-message.active {
            display: block;
        }
        
        /* ç©ºããªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .no-slots-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .no-slots-message p {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>ğŸŒ¸ ã¾ã¾ã‚ˆã‚</h1>
            <p>é¢è«‡äºˆç´„</p>
        </div>
        
        <!-- ãƒšãƒ¼ã‚¸1: æ—¥ä»˜é¸æŠ -->
        <div class="page active" id="page1">
            <div class="card">
                <h2>ğŸ“… é¢è«‡æ—¥ã‚’é¸æŠ</h2>
                
                <div class="info-box">
                    ã”å¸Œæœ›ã®é¢è«‡æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>
                    é¢è«‡æ™‚é–“ã¯30åˆ†ç¨‹åº¦ã§ã™ã€‚
                </div>
                
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prevMonth" onclick="changeMonth(-1)">â—€</button>
                    <h3 id="currentMonth"></h3>
                    <button class="calendar-nav-btn" id="nextMonth" onclick="changeMonth(1)">â–¶</button>
                </div>
                
                <div class="weekday-header">
                    <div class="weekday">æ—¥</div>
                    <div class="weekday">æœˆ</div>
                    <div class="weekday">ç«</div>
                    <div class="weekday">æ°´</div>
                    <div class="weekday">æœ¨</div>
                    <div class="weekday">é‡‘</div>
                    <div class="weekday">åœŸ</div>
                </div>
                
                <div class="calendar-grid" id="calendarGrid"></div>
                
                <button class="btn btn-primary" id="selectDateBtn" disabled onclick="showPage(2)">
                    ã“ã®æ—¥ã§æ™‚é–“ã‚’é¸ã¶
                </button>
            </div>
        </div>
        
        <!-- ãƒšãƒ¼ã‚¸2: æ™‚é–“é¸æŠ -->
        <div class="page" id="page2">
            <div class="card">
                <h2>ğŸ• æ™‚é–“ã‚’é¸æŠ</h2>
                
                <div class="selected-datetime">
                    <div class="date" id="selectedDateDisplay"></div>
                    <div class="time">ã®ç©ºãæ </div>
                </div>
                
                <div class="error-message" id="errorMessage"></div>
                
                <div id="timeSlotsContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ç©ºãæ ã‚’å–å¾—ä¸­...</p>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="showPage(1)">â† æ—¥ä»˜ã‚’é¸ã³ç›´ã™</button>
                <button class="btn btn-primary" id="confirmBtn" disabled onclick="confirmReservation()">
                    ã“ã®æ—¥æ™‚ã§äºˆç´„ã™ã‚‹
                </button>
            </div>
        </div>
        
        <!-- ãƒšãƒ¼ã‚¸3: äºˆç´„å‡¦ç†ä¸­ -->
        <div class="page" id="page3">
            <div class="card">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>äºˆç´„ã‚’ç¢ºå®šã—ã¦ã„ã¾ã™...</p>
                </div>
            </div>
        </div>
        
        <!-- ãƒšãƒ¼ã‚¸4: å®Œäº† -->
        <div class="page" id="page4">
            <div class="card">
                <div class="complete-icon">
                    <div class="checkmark">
                        <svg viewBox="0 0 24 24">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                        </svg>
                    </div>
                </div>
                
                <div class="complete-message">
                    <h2>äºˆç´„å®Œäº†ï¼</h2>
                    <p>é¢è«‡ã®ã”äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>å½“æ—¥ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚</p>
                </div>
                
                <div class="reservation-details">
                    <h3>ğŸ“‹ äºˆç´„å†…å®¹</h3>
                    <div class="detail-row">
                        <span class="label">æ—¥æ™‚</span>
                        <span class="value" id="reservationDateTime"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">å½¢å¼</span>
                        <span class="value">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é¢è«‡</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">æ‰€è¦æ™‚é–“</span>
                        <span class="value">ç´„30åˆ†</span>
                    </div>
                </div>
                
                <div class="info-box">
                    é¢è«‡æ—¥æ™‚ã®å¤‰æ›´ã‚„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã€LINEã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚
                </div>
                
                <button class="btn btn-primary" onclick="closeLiff()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const CONFIG = {
            LIFF_ID: '2008409890-bdVxpkD0'  // æœ¬ç•ªç”¨LIFF ID
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let lineProfile = null;
        let currentMonth = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let selectedEndTime = null;

        // æ—¥æœ¬ã®ç¥æ—¥ï¼ˆ2024-2025ï¼‰
        const holidays = [
            '2024-01-01', '2024-01-08', '2024-02-11', '2024-02-12', '2024-02-23',
            '2024-03-20', '2024-04-29', '2024-05-03', '2024-05-04', '2024-05-05',
            '2024-05-06', '2024-07-15', '2024-08-11', '2024-08-12', '2024-09-16',
            '2024-09-22', '2024-09-23', '2024-10-14', '2024-11-03', '2024-11-04',
            '2024-11-23', '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23',
            '2025-02-24', '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04',
            '2025-05-05', '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15',
            '2025-09-23', '2025-10-13', '2025-11-03', '2025-11-23', '2025-11-24'
        ];

// LIFFåˆæœŸåŒ–
window.addEventListener('load', async () => {
    // å¹´é¸æŠè‚¢åˆæœŸåŒ–
    initYearOptions();
    
    try {
        console.log('LIFFåˆæœŸåŒ–é–‹å§‹...');
        await liff.init({ liffId: CONFIG.LIFF_ID });
        console.log('LIFFåˆæœŸåŒ–æˆåŠŸ');
        console.log('isInClient:', liff.isInClient());
        console.log('isLoggedIn:', liff.isLoggedIn());
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‹ã©ã†ã‹ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const hasLiffParams = urlParams.has('liffClientId') || urlParams.has('code');
        
        if (liff.isLoggedIn()) {
            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
            lineProfile = await liff.getProfile();
            console.log('LINE Profile:', lineProfile);
        } else if (hasLiffParams) {
            // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã ãŒisLoggedIn=falseï¼ˆå¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã®å•é¡Œï¼‰
            console.log('ãƒ­ã‚°ã‚¤ãƒ³å¾Œã ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¶­æŒã•ã‚Œã¦ã„ãªã„');
            console.log('å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®åˆ¶é™ã®ãŸã‚ã€LINEã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ãã ã•ã„');
            showExternalBrowserMessage();
            return;
        } else if (liff.isInClient()) {
            // LINEã‚¢ãƒ—ãƒªå†…ã§æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
            console.log('LINEã‚¢ãƒ—ãƒªå†…ã§æœªãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸');
            liff.login();
            return;
        } else {
            // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§åˆå›ã‚¢ã‚¯ã‚»ã‚¹ â†’ è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ
            console.log('å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§æœªãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸');
            liff.login();
            return;
        }
        
    } catch (error) {
        console.error('LIFF initialization failed:', error);
    }
});

// å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showExternalBrowserMessage() {
    const container = document.querySelector('.container');
    const messageCard = document.createElement('div');
    messageCard.className = 'card';
    messageCard.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“±</div>
            <h2 style="margin-bottom: 20px;">LINEã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ãã ã•ã„</h2>
            <p style="color: #666; line-height: 1.8; margin-bottom: 20px;">
                ã“ã®ãƒšãƒ¼ã‚¸ã¯LINEã‚¢ãƒ—ãƒªå†…ã§<br>é–‹ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
            </p>
            <p style="color: #888; font-size: 0.9em; line-height: 1.6;">
                LINEã®ãƒˆãƒ¼ã‚¯ç”»é¢ã‹ã‚‰<br>ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<br>ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>
    `;
    
    document.querySelectorAll('.page').forEach(page => {
        page.style.display = 'none';
    });
    container.insertBefore(messageCard, container.firstChild.nextSibling);
}

        // æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        function showLoginButton() {
            const container = document.querySelector('.container');
            const loginCard = document.createElement('div');
            loginCard.className = 'card';
            loginCard.id = 'loginCard';
            loginCard.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h2 style="margin-bottom: 20px;">ğŸ” LINEãƒ­ã‚°ã‚¤ãƒ³</h2>
                    <p style="color: #666; line-height: 1.8; margin-bottom: 30px;">
                        é¢è«‡äºˆç´„ã«ã¯LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚
                    </p>
                    <button class="btn btn-primary" onclick="manualLogin()" style="margin-top: 0;">
                        LINEã§ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                    <p style="color: #888; font-size: 0.85em; margin-top: 20px;">
                        â€» LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ãã¨<br>è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚Œã¾ã™
                    </p>
                </div>
            `;
            
            // æ—¢å­˜ã®ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            container.insertBefore(loginCard, container.firstChild.nextSibling);
        }

        // æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³
        function manualLogin() {
            sessionStorage.setItem('liff_login_attempted', 'true');
            liff.login({ redirectUri: window.location.href });
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('currentMonth');
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            monthDisplay.textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // ä»Šæ—¥ã®æ—¥ä»˜
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // 2é€±é–“å¾Œ
            const twoWeeksLater = new Date(today);
            twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
            
            // ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
            grid.innerHTML = '';
            
            // æœˆã®æœ€åˆã®æ—¥ã®æ›œæ—¥åˆ†ã®ç©ºã‚»ãƒ«ã‚’è¿½åŠ 
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyCell = document.createElement('button');
                emptyCell.className = 'date-cell empty';
                emptyCell.disabled = true;
                grid.appendChild(emptyCell);
            }
            
            // æ—¥ä»˜ã‚»ãƒ«ã‚’è¿½åŠ 
            for (let date = 1; date <= lastDay.getDate(); date++) {
                const cellDate = new Date(year, month, date);
                const dateStr = formatDate(cellDate);
                const dayOfWeek = cellDate.getDay();
                
                const cell = document.createElement('button');
                cell.className = 'date-cell';
                cell.textContent = date;
                
                // æ›œæ—¥ã«ã‚ˆã‚‹è‰²åˆ†ã‘
                if (dayOfWeek === 0) cell.classList.add('sunday');
                if (dayOfWeek === 6) cell.classList.add('saturday');
                
                // é¸æŠä¸å¯æ¡ä»¶
                const isPast = cellDate < today;
                const isTooFar = cellDate > twoWeeksLater;
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isHoliday = holidays.includes(dateStr);
                
                if (isPast || isTooFar || isWeekend || isHoliday) {
                    cell.disabled = true;
                } else {
                    cell.onclick = () => selectDate(cellDate, cell);
                }
                
                // é¸æŠä¸­ã®æ—¥ä»˜
                if (selectedDate && dateStr === formatDate(selectedDate)) {
                    cell.classList.add('selected');
                }
                
                grid.appendChild(cell);
            }
            
            // å‰æœˆãƒ»æ¬¡æœˆãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
            const prevBtn = document.getElementById('prevMonth');
            const nextBtn = document.getElementById('nextMonth');
            
            const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            prevBtn.disabled = currentMonth <= thisMonth;
            
            const maxMonth = new Date(twoWeeksLater.getFullYear(), twoWeeksLater.getMonth(), 1);
            nextBtn.disabled = currentMonth >= maxMonth;
        }

        // æœˆåˆ‡ã‚Šæ›¿ãˆ
        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        // æ—¥ä»˜é¸æŠ
        function selectDate(date, cell) {
            // ä»¥å‰ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.date-cell.selected').forEach(c => {
                c.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠ
            cell.classList.add('selected');
            selectedDate = date;
            
            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('selectDateBtn').disabled = false;
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (YYYY-MM-DD)
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // æ—¥ä»˜ã‚’æ—¥æœ¬èªã§è¡¨ç¤º
        function formatDateJapanese(date) {
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
        }

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function showPage(pageNum) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('page' + pageNum).classList.add('active');
            window.scrollTo(0, 0);
            
            // ãƒšãƒ¼ã‚¸2ï¼ˆæ™‚é–“é¸æŠï¼‰ã®å ´åˆã€ç©ºãæ ã‚’å–å¾—
            if (pageNum === 2) {
                document.getElementById('selectedDateDisplay').textContent = formatDateJapanese(selectedDate);
                loadTimeSlots();
            }
        }

        // ç©ºãæ ã‚’å–å¾—
        async function loadTimeSlots() {
            const container = document.getElementById('timeSlotsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>ç©ºãæ ã‚’å–å¾—ä¸­...</p></div>';
            
            selectedTime = null;
            selectedEndTime = null;
            document.getElementById('confirmBtn').disabled = true;

            try {
                const dateStr = formatDate(selectedDate);
                const response = await fetch(`/api/get-available-slots?date=${dateStr}`);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'ç©ºãæ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const slots = data.slots || [];
                const availableSlots = slots.filter(s => s.available);

                if (availableSlots.length === 0) {
                    container.innerHTML = `
                        <div class="no-slots-message">
                            <p>ğŸ˜” ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“</p>
                            <p>ã“ã®æ—¥ã¯ç©ºããŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>åˆ¥ã®æ—¥ã‚’ãŠé¸ã³ãã ã•ã„ã€‚</p>
                        </div>
                    `;
                    return;
                }

                // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’è¡¨ç¤º
                container.innerHTML = '<div class="time-slots" id="timeSlots"></div>';
                const slotsGrid = document.getElementById('timeSlots');

                slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.className = 'time-slot';
                    btn.innerHTML = `
                        <div class="slot-time">${slot.start}</div>
                        <div class="slot-status">${slot.available ? 'â— ç©ºã' : 'Ã— äºˆç´„æ¸ˆ'}</div>
                    `;
                    
                    if (!slot.available) {
                        btn.disabled = true;
                    } else {
                        btn.onclick = () => selectTimeSlot(slot, btn);
                    }
                    
                    slotsGrid.appendChild(btn);
                });

            } catch (error) {
                console.error('Error loading time slots:', error);
                container.innerHTML = `
                    <div class="no-slots-message">
                        <p>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆé¸æŠ
        function selectTimeSlot(slot, btn) {
            // ä»¥å‰ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.time-slot.selected').forEach(b => {
                b.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠ
            btn.classList.add('selected');
            selectedTime = slot.start;
            selectedEndTime = slot.end;
            
            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('confirmBtn').disabled = false;
        }

        // äºˆç´„ç¢ºå®š
        async function confirmReservation() {
            showPage(3); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢

            try {
                const response = await fetch('/api/create-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lineUserId: lineProfile?.userId,
                        date: formatDate(selectedDate),
                        startTime: selectedTime,
                        endTime: selectedEndTime
                    })
                });

                const result = await response.json();
                console.log('Reservation result:', result);

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // äºˆç´„å†…å®¹ã‚’è¡¨ç¤º
                document.getElementById('reservationDateTime').textContent = 
                    `${formatDateJapanese(selectedDate)} ${selectedTime}ã€œ`;

                showPage(4); // å®Œäº†ç”»é¢

            } catch (error) {
                console.error('Reservation error:', error);
                showError(error.message);
                showPage(2); // æ™‚é–“é¸æŠç”»é¢ã«æˆ»ã‚‹
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.add('active');
            
            setTimeout(() => {
                errorElement.classList.remove('active');
            }, 5000);
        }

        // LIFFã‚’é–‰ã˜ã‚‹
        function closeLiff() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }
    </script>
</body>
</html>
